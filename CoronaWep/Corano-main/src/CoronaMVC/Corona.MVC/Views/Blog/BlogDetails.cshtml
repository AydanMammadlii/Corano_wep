@using System.Linq
@using Corona.Application.DTOs.Comments
@using Corona.MVC.ViewModel.Blog
@model BlogViewModel
@{
    var comments = ViewBag.Comments as IEnumerable<GetCommentDto>;
    var commentsCount = comments != null ? comments.Count() : 0;
}

<main>
    <!-- breadcrumb area start -->
    <div class="breadcrumb-area">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="breadcrumb-wrap">
                        <nav aria-label="breadcrumb">
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item"><a href="index.html"><i class="fa fa-home"></i></a></li>
                                <li class="breadcrumb-item"><a href="blog-left-sidebar.html">blog</a></li>
                                <li class="breadcrumb-item active" aria-current="page">blog details right sidebar</li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- breadcrumb area end -->
    <!-- blog main wrapper start -->
    <div class="blog-main-wrapper section-padding">
        <div class="container">
            <div class="row">
                <div class="col-lg-3 order-2">
                    <aside class="blog-sidebar-wrapper">
                        <div class="blog-sidebar">
                            <h5 class="title">search</h5>
                            <div class="sidebar-serch-form">
                                <form action="#">
                                    <input type="text" class="search-field" placeholder="search here">
                                    <button type="submit" class="search-btn"><i class="fa fa-search"></i></button>
                                </form>
                            </div>
                        </div> <!-- single sidebar end -->
                        <div class="blog-sidebar">
                            <h5 class="title">categories</h5>
                            <ul class="blog-archive blog-category">
                                @foreach (var item in ViewBag.Categories)
                                {
                                    <li><a>@item.Title</a></li>
                                }
                            </ul>
                        </div> <!-- single sidebar end -->
                        <div class="blog-sidebar">
                            <h5 class="title">Blog Archives</h5>
                            <ul class="blog-archive">
                                <li><a href="#">January (10)</a></li>
                                <li><a href="#">February (08)</a></li>
                                <li><a href="#">March (07)</a></li>
                                <li><a href="#">April (14)</a></li>
                                <li><a href="#">May (10)</a></li>
                            </ul>
                        </div> <!-- single sidebar end -->
                    </aside>
                </div>
                <div class="col-lg-9 order-1">
                    <div class="blog-item-wrapper">
                        <!-- blog post item start -->
                        <div class="blog-post-item blog-details-post">
                            <figure class="blog-thumb">
                                <div class="blog-carousel-2 slick-row-15 slick-arrow-style slick-dot-style">
                                    @foreach (var item in Model.GetBlogImageDtos)
                                    {
                                        <div class="blog-single-slide">
                                            <img src="@item.ImageUrl" alt="blog image">
                                        </div>
                                    }
                                </div>
                            </figure>
                            <div class="blog-content">
                                <h3 class="blog-title">
                                    @Model.Title
                                </h3>
                                <div class="blog-meta">
                                    <p>@Model.CreatedDate.ToString("dd/MM/yyyy") | <a href="#">Corano</a></p>
                                </div>
                                <div class="entry-summary">
                                    <p>
                                        @Model.Description
                                    </p>
                                    <blockquote>
                                        <p>
                                            Quisque semper nunc vitae erat pellentesque, ac placerat arcu consectetur.
                                            venenatis elit ac ultrices convallis. Duis est nisi, tincidunt ac urna sed,
                                            cursus blandit lectus. In ullamcorper sit amet ligula ut eleifend. Proin
                                            dictum
                                            tempor ligula, ac feugiat metus. Sed finibus tortor eu scelerisque
                                            scelerisque.
                                        </p>
                                    </blockquote>
                                    <p>
                                        Pariatur praesentium,
                                        corrupti
                                        deserunt ducimus quo doloremque nostrum aspernatur saepe cupiditate sit autem
                                        exercitationem debitis, maiores vitae perferendis nemo? Voluptas illo, animi
                                        temporibus quod earum molestias eaque, iure rem amet autem dignissimos officia
                                        dolores numquam distinctio esse voluptates optio pariatur aspernatur omnis?
                                        Ipsam
                                        qui commodi velit natus reiciendis quod quibusdam nemo eveniet similique animi!
                                    </p>
                                    <div class="blog-share-link">
                                        <h6>Share :</h6>
                                        <div class="blog-social-icon">
                                            <a href="#" class="facebook"><i class="fa fa-facebook"></i></a>
                                            <a href="#" class="twitter"><i class="fa fa-twitter"></i></a>
                                            <a href="#" class="pinterest"><i class="fa fa-pinterest"></i></a>
                                            <a href="#" class="google"><i class="fa fa-google-plus"></i></a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- blog post item end -->
                        <!-- comment area start -->
                        <div class="comment-section section-padding">
                            <h5>@commentsCount Comments</h5>
                            <ul>
                                @foreach (var item in ViewBag.Comments)
                                {
                                    <li>
                                        <div class="author-avatar">
                                            <img src="~/assets/img/blog/comment-icon.png" alt="">
                                        </div>
                                        <div class="comment-body">
                                            <span class="reply-btn"></span>
                                            <h5 class="comment-author">@item.AppUserDto.UserName</h5>
                                            <div class="comment-post-date">
                                                @item.CreatedDate.ToString("dd/MM/yyyy")
                                            </div>
                                            <p>
                                                @item.CommentText
                                            </p>
                                        </div>
                                    </li>
                                }
                            </ul>
                        </div>
                        <!-- comment area end -->
                        <!-- start blog comment box -->
                        @if (ViewBag.Token is not null)
                        {
                            <div class="blog-comment-wrapper">
                                <h5>Leave a reply</h5>
                                <p>Your email address will not be published. Required fields are marked *</p>
                                <form id="commentForm">
                                    <div class="comment-post-box">
                                        <div class="row">
                                            <div class="col-12">
                                                <label>Comment</label>
                                                <textarea name="commentText" placeholder="Write a comment"></textarea>
                                            </div>
                                            <div class="col-12">
                                                <div class="coment-btn">
                                                    <input class="btn btn-sqr" type="button" id="postCommentBtn" value="Post Comment">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- blog main wrapper end -->
</main>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        $('#postCommentBtn').click(function (e) {
            e.preventDefault();

            var commentText = $('textarea[name="commentText"]').val();
            var blogId = '@Model.Id';
            var appUserId = '@ViewBag.AppUserId';

            var data = {
                CommentText: commentText,
                BlogId: blogId,
                AppUserId: appUserId
            };

            $.ajax({
                url: 'https://localhost:7295/api/Comments/CreateComment',
                type: 'POST',
                data: data,
                success: function (response) {
                    alert('Comment posted successfully!');
                    location.reload(); // Reload the page to see the new comment
                },
                error: function (xhr, status, error) {
                    alert('Failed to post comment: ' + error);
                }
            });
        });
    });
</script>
